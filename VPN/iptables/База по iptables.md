

[База или объяснение   ](https://docs.vscale.io/blog/iptables-for-beginners/#:~:text=Iptables%20%E2%80%94%20%D0%BC%D0%BE%D1%89%D0%BD%D1%8B%D0%B9%20%D0%B8%D0%BD%D1%81%D1%82%D1%80%D1%83%D0%BC%D0%B5%D0%BD%D1%82%20%D0%B4%D0%BB%D1%8F%20%D1%83%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F,%D0%B7%D0%B0%D1%89%D0%B8%D1%82%D0%B8%D1%82%D1%8C%20%D1%81%D0%B2%D0%BE%D0%B8%20%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D1%8B%20%D0%B8%20%D1%81%D0%B5%D1%82%D0%B8)


**Iptables** — мощный инструмент для управления сетевой безопасностью в Linux. В этой статье ты узнаешь, как работать с Iptables: от создания базовых правил фильтрации трафика до продвинутых настроек, таких как логирование и настройка VPN. Это руководство поможет тебе эффективно защитить свои серверы и сети.

### Основы работы с Iptables​

Iptables работает, проверяя входящие и исходящие сетевые пакеты на соответствие определённым критериям и применяя к ним действия, указанные в правилах. Эти правила организованы в таблицы, каждая из которых предназначена для выполнения специфических задач. Понимание работы таблиц и цепочек в Iptables — это основа для создания эффективных и безопасных сетевых правил.

#### Основные таблицы в Iptables​

В Iptables существует четыре основные таблицы, каждая из которых служит для конкретной задачи:

- **Filter**: Основная таблица, используемая для фильтрации пакетов. В этой таблице обрабатываются правила, определяющие, какие пакеты разрешены, а какие — заблокированы.
    
- **NAT (Network Address Translation)**: Эта таблица отвечает за трансляцию сетевых адресов, что позволяет скрывать внутреннюю сеть от внешнего мира, изменяя адреса и порты в пакетах данных.
    
- **Mangle**: Таблица, используемая для модификации заголовков пакетов, например, для изменения маршрутизации или приоритета трафика.
    
- **Raw**: Таблица, позволяющая обходить систему отслеживания состояний пакетов. Она используется для исключения определённых пакетов из стандартного контроля. Следует отметить, что эта таблица применяется редко и в специфических случаях.
    

#### Цепочки и их использование​

Каждая таблица в Iptables состоит из цепочек. Цепочка — это последовательность правил, которые применяются к каждому пакету. В Iptables существует три основные встроенные цепочки:

- **INPUT**: Эта цепочка обрабатывает пакеты, которые предназначены для самой системы. Например, через неё проходят все запросы на соединение с сервером.
    
- **FORWARD**: Цепочка предназначена для обработки транзитных пакетов, которые проходят через систему, но не предназначены для неё самой. Например, это актуально для маршрутизаторов.
    
- **OUTPUT**: В этой цепочке обрабатываются все пакеты, исходящие из системы. Она управляет, какой трафик может покинуть сервер.
    

### Основные команды Iptables​

Для управления Iptables используются команды, которые позволяют добавлять, изменять или удалять правила, а также просматривать текущие настройки. Рассмотрим основные команды и их применение.

#### Просмотр текущих правил​

Чтобы увидеть все текущие правила фильтрации, достаточно использовать команду:

```
iptables -L
```

Эта команда по умолчанию покажет правила в таблице `Filter`, отображая их в последовательности, в которой они применяются к пакетам. Если нужно просмотреть правила в другой таблице, например, в таблице `NAT`, добавь флаг `-t` и укажи нужную таблицу:

```
iptables -t nat -L
```

Можно добавить флаг `-v` для отображения более детальной информации, такой как счётчики пакетов и байтов, прошедших через каждое правило.

#### Добавление новых правил​

Добавление новых правил — одна из основных задач при настройке Iptables. Например, чтобы заблокировать весь трафик от определённого IP-адреса, можно использовать следующую команду:

```
iptables -A INPUT -s 192.168.0.100 -j DROP
```

Здесь:

- `-A INPUT` добавляет правило в цепочку `INPUT`, которая обрабатывает входящий трафик.
- `-s 192.168.0.100` указывает исходный IP-адрес пакетов, на которые будет распространяться правило.
- `-j DROP` указывает, что все пакеты, соответствующие данному правилу, будут отброшены.

Эти параметры команд соответствуют стандартам использования Iptables, и аналогичные примеры часто встречаются в настройке межсетевых экранов.

#### Удаление правил​

Удаление существующих правил в Iptables требует знания их точного положения в цепочке. Чтобы узнать номера правил, используй команду:

```
iptables -L --line-numbers
```

Эта команда добавляет номера строк перед каждым правилом, что упрощает их удаление. Чтобы удалить конкретное правило, укажи его номер в следующей команде:

```
iptables -D INPUT 1
```

Эта команда удаляет первое правило в цепочке `INPUT`.

#### Изменение политики по умолчанию​

По умолчанию Iptables принимает все входящие и исходящие пакеты, если иное не указано в правилах. Для повышения безопасности можно изменить политику по умолчанию на более строгую. Например, чтобы отклонять все входящие пакеты по умолчанию, кроме явно разрешённых, можно использовать команду:

```
iptables -P INPUT DROP
```

Эта команда изменяет политику по умолчанию для цепочки `INPUT`, заставляя Iptables отклонять все входящие пакеты, если нет других соответствующих правил. Такой подход позволяет минимизировать вероятность проникновения нежелательного трафика в систему.

### Сохранение и восстановление правил​

Правила Iptables по умолчанию не сохраняются при перезагрузке системы. Чтобы сохранить текущие правила и восстановить их после перезагрузки, можно использовать следующие команды:

```
iptables-save > /etc/iptables/rules.v4
```

Эта команда сохраняет текущие правила в файл `/etc/iptables/rules.v4`. Для восстановления этих правил после перезагрузки используется команда:

```
iptables-restore < /etc/iptables/rules.v4
```

Также можно настроить автоматическое восстановление правил при старте системы через инициализационные скрипты или systemd.

### Примеры использования Iptables​

Применение Iptables может варьироваться от простых задач, таких как блокировка определённых IP-адресов, до сложных конфигураций межсетевого экрана, управляемого множеством правил.

#### Блокировка IP-адреса​

Простейший пример использования Iptables — это блокировка трафика от определённого IP-адреса. Это может быть полезно для защиты системы от нежелательных соединений:

```
iptables -A INPUT -s 192.168.0.100 -j DROP
```

В этом примере весь трафик от IP-адреса `192.168.0.100` будет отброшен на уровне входящего трафика.

#### Открытие порта для входящего трафика​

Чтобы разрешить входящий трафик на определённый порт, например, на порт 80 для HTTP-трафика, можно использовать команду:

```
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
```

Здесь:

- `-p tcp` указывает протокол TCP.
- `--dport 80` указывает целевой порт.
- `-j ACCEPT` разрешает прохождение пакетов через этот порт.

Этот пример показывает, как можно избирательно открывать порты для входящего трафика, поддерживая безопасность системы.

#### Настройка простого файрвола​

Создание простого, но эффективного файрвола может включать разрешение исходящего трафика и ограничение входящего только определёнными портами. Пример такой настройки:

```
iptables -A OUTPUT -j ACCEPTiptables -A INPUT -p tcp --dport 22 -j ACCEPTiptables -A INPUT -p tcp --dport 80 -j ACCEPTiptables -A INPUT -p tcp --dport 443 -j ACCEPTiptables -P INPUT DROP
```

В этом сценарии:

- `iptables -A OUTPUT -j ACCEPT` разрешает весь исходящий трафик.
- `iptables -A INPUT -p tcp --dport 22 -j ACCEPT` разрешает входящий трафик на порт 22 для SSH.
- `iptables -A INPUT -p tcp --dport 80 -j ACCEPT` разрешает входящий трафик на порт 80 для HTTP.
- `iptables -A INPUT -p tcp --dport 443 -j ACCEPT` разрешает входящий трафик на порт 443 для HTTPS.
- `iptables -P INPUT DROP` отклоняет весь остальной входящий трафик по умолчанию.

Эта конфигурация позволяет создать базовый межсетевой экран, защищающий сервер от нежелательных подключений.

### Продвинутое использование Iptables​

#### Логирование пакетов​

Iptables предоставляет мощный инструмент для логирования пакетов, проходящих через систему. Это может быть особенно полезно для диагностики и мониторинга сетевой активности. Чтобы включить логирование пакетов, можно использовать следующую команду:

```
iptables -A INPUT -j LOG --log-prefix "Dropped Packet: "iptables -A INPUT -j DROP
```

Здесь:

- `--log-prefix "Dropped Packet: "` добавляет указанный префикс к каждому сообщению журнала, что упрощает фильтрацию и анализ логов.
- `-j LOG` указывает на необходимость логирования пакета, а `-j DROP` — на его дальнейшее отклонение.

#### Создание пользовательских цепочек​

Для более гибкой настройки сетевых правил можно создавать пользовательские цепочки. Это позволяет группировать правила и упрощать управление сложными конфигурациями:

```
iptables -N MY_CHAINiptables -A MY_CHAIN -s 192.168.0.100 -j DROPiptables -A INPUT -j MY_CHAIN
```

В этом примере:

- `-N MY_CHAIN` создаёт новую цепочку с именем `MY_CHAIN`.
- `iptables -A MY_CHAIN -s 192.168.0.100 -j DROP` добавляет правило, которое блокирует трафик от IP-адреса `192.168.0.100` в этой цепочке.
- `iptables -A INPUT -j MY_CHAIN` подключает пользовательскую цепочку к основной цепочке `INPUT`.

Использование таких цепочек помогает управлять правилами более эффективно и упрощает их поддержку.

#### Использование состояний пакетов​

Одним из мощных инструментов Iptables является возможность отслеживания состояний пакетов. Это позволяет создавать более сложные правила, которые учитывают, к какому соединению относится пакет. Например:

```
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
```

Здесь:

- `-m state` включает использование модуля отслеживания состояний.
- `--state ESTABLISHED,RELATED` применяет правило только к пакетам, которые являются частью уже установленного или связанного соединения.

Это позволяет улучшить безопасность, разрешая только ожидаемый трафик и блокируя несанкционированные попытки подключения.

#### Настройка VPN с использованием Iptables​

Iptables также можно использовать при создании и управления VPN (Virtual Private Network). Например, для настройки IPsec VPN можно использовать следующие команды:

```
iptables -A INPUT -m policy --dir in --pol ipsec -j ACCEPTiptables -A OUTPUT -m policy --dir out --pol ipsec -j ACCEPT
```

Здесь:

- `-m policy` указывает на использование модуля политики.
- `--dir in` и `--dir out` определяют направление трафика.
- `--pol ipsec` указывает на использование политики IPsec.

Эти команды позволяют настроить фильтрацию трафика, проходящего через VPN, обеспечивая его безопасность и защищённость. Важно отметить, что эти правила применимы только к трафику, уже защищённому IPsec.

### Заключение​

Iptables — это универсальный и мощный инструмент для управления сетевыми подключениями в Linux. Он предоставляет широкие возможности для фильтрации трафика, настройки трансляции адресов, логирования событий и многого другого. Несмотря на его сложность, освоение Iptables позволяет существенно повысить уровень безопасности и контроля над сетью. Этот инструмент необходим для любого системного администратора, стремящегося обеспечить надёжную защиту своих серверов и сетей.